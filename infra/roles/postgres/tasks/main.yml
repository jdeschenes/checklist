- name: Install Postgres packages
  ansible.builtin.apt:
    name:
      - "postgresql-{{ postgresql_version }}"
      - "postgresql-contrib"
    state: present

- name: Install Python Postgres driver (psycopg2)
  ansible.builtin.apt:
    name: python3-psycopg2
    state: present
  register: psycopg2_install
  failed_when: false

- name: Install Python Postgres driver (psycopg3)
  ansible.builtin.apt:
    name: python3-psycopg
    state: present
  when: psycopg2_install is failed

- name: Ensure Postgres conf.d directory exists
  ansible.builtin.file:
    path: "/etc/postgresql/{{ postgresql_version }}/main/conf.d"
    state: directory
    owner: postgres
    group: postgres
    mode: "0755"

- name: Write Postgres custom config
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: "{{ postgresql_custom_conf }}"
    owner: postgres
    group: postgres
    mode: "0644"
  notify: restart postgres

- name: Write pg_hba.conf
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: "0640"
  notify: reload postgres

- name: Ensure Postgres is running
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: true

- name: Ensure application database user exists
  become_user: postgres
  community.postgresql.postgresql_user:
    name: "{{ postgresql_db_user }}"
    password: "{{ postgresql_db_password }}"
    role_attr_flags: LOGIN
  when: postgresql_db_password | length > 0

- name: Ensure application database exists
  become_user: postgres
  community.postgresql.postgresql_db:
    name: "{{ postgresql_db_name }}"
    owner: "{{ postgresql_db_user }}"
    encoding: UTF8
    template: template0
    lc_collate: "{{ postgresql_db_lc_collate }}"
    lc_ctype: "{{ postgresql_db_lc_ctype }}"
